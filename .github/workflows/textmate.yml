name: textmate-macos-26
on:
  workflow_dispatch:

jobs:
  build-textmate-macos:
    runs-on: macos-26

    env:
      BUILD_DIR: ${{ github.workspace }}/tm-build
      MACOSX_DEPLOYMENT_TARGET: "26.0"

    steps:
      - name: Clone source
        run: |
          git clone --recursive --depth 1 https://github.com/textmate/textmate.git textmate

      - name: Install deps
        run: |
          brew install boost capnp google-sparsehash multimarkdown ninja ragel tree

      - name: Configure
        working-directory: textmate
        run: |
          set -euo pipefail

          BREW_PREFIX="$(brew --prefix)"

          printf 'add FLAGS "-I%s/include"\nadd LN_FLAGS "-L%s/lib"\n' \
            "$BREW_PREFIX" "$BREW_PREFIX" > local.rave

          mkdir -p "$BUILD_DIR"

          export builddir="$BUILD_DIR"

          ./configure

      - name: Build
        working-directory: textmate
        run: |
          set -euo pipefail
          ninja -C "$BUILD_DIR" TextMate

      - name: List files
        run: |
          set -euo pipefail
          tree "$BUILD_DIR/release" || true
          ls -la "$BUILD_DIR/release/Applications/TextMate" || true

      - name: Package DMG
        run: |
          set -euo pipefail

          APP="$BUILD_DIR/release/Applications/TextMate/TextMate.app"
          test -d "$APP"

          rm -rf dist
          mkdir -p dist/stage

          # Copy app into staging folder
          ditto "$APP" "dist/stage/TextMate.app"

          # Drag-to-install convenience symlink
          ln -s /Applications "dist/stage/Applications"

          # Build compressed DMG (UDZO)
          hdiutil create \
            -volname "TextMate" \
            -srcfolder "dist/stage" \
            -ov \
            -format UDZO \
            "dist/TextMate-macos-26-arm64.dmg"

          ls -lh dist

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: TextMate-macos-26-arm64
          path: dist/TextMate-macos-26-arm64.dmg

name: textmate-macos-26
on:
  workflow_dispatch:

jobs:
  build-textmate-macos:
    runs-on: macos-26
    env:
      MACOSX_DEPLOYMENT_TARGET: "26.0"
    steps:
      - name: Clone source
        run: |
          git clone --recursive --depth 1 https://github.com/textmate/textmate.git textmate
    
      - name: Install deps
        run: |
          brew install boost capnp google-sparsehash multimarkdown ninja ragel tree

      - name: Configure
        working-directory: textmate
        run: |
          BREW_PREFIX="$(brew --prefix)"
          cat > local.rave <<EOF
          add FLAGS "-I${BREW_PREFIX}/include"
          add LN_FLAGS "-L${BREW_PREFIX}/lib"
          EOF
          ./configure

      - name: Build
        working-directory: textmate
        run: |
          ninja TextMate
      
      - name: Package DMG
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="$HOME/build/textmate/release/Applications/TextMate/TextMate.app"
          DIST_DIR="$GITHUB_WORKSPACE/dist"
          DMG_ROOT="$DIST_DIR/dmgroot"

          rm -rf "$DIST_DIR"
          mkdir -p "$DMG_ROOT"

          # Copy the .app bundle (ditto preserves bundle metadata better than cp -R)
          /usr/bin/ditto "$APP_PATH" "$DMG_ROOT/TextMate.app"

          # Common DMG convenience link
          ln -s /Applications "$DMG_ROOT/Applications"

          # Create compressed read-only DMG
          DMG_NAME="TextMate-${{ github.sha }}-macos26-arm64.dmg"
          hdiutil create \
            -volname "TextMate" \
            -srcfolder "$DMG_ROOT" \
            -ov \
            -format UDZO \
            "$DIST_DIR/$DMG_NAME"

          echo "DMG created at: $DIST_DIR/$DMG_NAME"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: TextMate-macos26-arm64
          path: dist/*.dmg



